FROM oven/bun:1 AS base
WORKDIR /usr/src/app

# Prune stage - turbo figures out exactly what's needed
FROM base AS prune
RUN bun install --global turbo
COPY . .
RUN turbo prune @photon/api --docker

# Install stage - uses the pruned lockfile
FROM base AS install
WORKDIR /usr/src/app

# Install build tools required by native dependencies (ssh2 via node-gyp)
RUN apt-get update && \
    apt-get install -y python3 make g++ && \
    rm -rf /var/lib/apt/lists/*

# Copy the json structure generated by turbo prune
COPY --from=prune /usr/src/app/out/json/ .
COPY --from=prune /usr/src/app/out/bun.lock ./bun.lock
# Install the dependencies
RUN bun install --frozen-lockfile

# Build stage
FROM base AS build
# Copy the installed node_modules (all of them, including workspace packages)
COPY --from=install /usr/src/app/ .
# Copy the source files from turbo prune on top
COPY --from=prune /usr/src/app/out/full/ .
# Copy the lockfile so turbo can resolve workspaces
COPY --from=prune /usr/src/app/out/bun.lock ./bun.lock
ENV NODE_ENV=production
RUN bun run build --filter=@photon/api

# Final image
FROM oven/bun:1-slim AS release
WORKDIR /usr/src/app
COPY --from=build /usr/src/app/apps/api/dist ./dist
COPY --from=install /usr/src/app/node_modules ./node_modules

USER bun
EXPOSE 4000/tcp
ENTRYPOINT ["bun", "run", "./dist/index.js"]

