FROM oven/bun:1 AS base
WORKDIR /usr/src/app

# Prune stage - turbo figures out exactly what's needed
FROM base AS prune
RUN bun install --global turbo
COPY . .
RUN turbo prune @photon/api --docker

# Install stage - uses the pruned lockfile
FROM base AS install
# Copy the json structure generated by turbo prune
COPY --from=prune /usr/src/app/out/json/ .
COPY --from=prune /usr/src/app/out/bun.lock ./bun.lock
# Install the dependencies
RUN bun install --frozen-lockfile

# Build stage
FROM base AS build
# Copy the node_modules
COPY --from=install /usr/src/app/node_modules ./node_modules
# Copy the source files from turbo prune
COPY --from=prune /usr/src/app/out/full/ .
ENV NODE_ENV=production
RUN bun run build --filter=@photon/api

# Final image
FROM oven/bun:1-alpine AS release
WORKDIR /usr/src/app
COPY --from=build /usr/src/app/apps/api/dist ./dist

USER bun
EXPOSE 4000/tcp
ENTRYPOINT ["bun", "run", "./dist/index.js"]
